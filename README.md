# Angular/Supabase Kanban
A simple kanban board using [Supabase](https://supabase.io) as the persistence layer

> Built with Supabase/Angular/PicoCSS

- [x] Supabase Auth
- [x] Partial CRUD implementation for boards/lists/tasks

# Setup
1. Clone repo and install dependencies
2. Rename `env.example.ts` to `environment.ts` and move to `environments/`, add your supabase credentials
3. Add schema, functions, RLS from the list below.
4. Run `npm run start`
4. Done!

## Schema
run the following

```
-- USERS
create table users (
  id         uuid references auth.users not null primary key, -- UUID from auth.users
  email text not null unique,
  name    text

  constraint name check(char_length(name) >= 3)
);

-- BOARDS
create table boards (
  id            bigint generated by default as identity primary key,
  name          text not null,
  description text,
  created_by    uuid references users not null  
);
  
-- LISTS
create table lists (
  id            bigint generated by default as identity primary key,
  name          text not null,
  board_id    bigint references boards on delete cascade not null,
  position float8 not null
);

-- TASKS 
create table tasks (
  id            bigint generated by default as identity primary key,
  list_id    bigint references lists on delete cascade not null,
  created_by    uuid references users not null,  
  title       text,
  description text,
  position float8 not null
);
```
## Functions and triggers

This function returns position to insert new task to
```
CREATE OR REPLACE FUNCTION increment_task_position(list_id_input BIGINT)
RETURNS FLOAT AS $$
DECLARE
    max_position FLOAT;
BEGIN
    -- Find the maximum position value in the specified list
    SELECT MAX(position) INTO max_position
    FROM public.tasks
    WHERE list_id = list_id_input;

    -- If there are no tasks in the list, set the initial position to 0.0
    IF max_position IS NULL THEN
        max_position := 0.0;
    END IF;

    -- Increment the position by 100 to place the new task at the end of the list
    max_position = max_position + 100;

    RETURN max_position;
END;
$$ LANGUAGE plpgsql;
```

This trigger automatically creates a profile entry when a new user signs up via Supabase Auth.
```
create OR replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.users (id, email, name)
  values (new.id, new.email, new.email);
  return new;
end;

$$ language plpgsql security definer;
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
  ```

## RLS
rls for boards
```
alter table boards enable row level security;

create policy "Individuals can insert their own board." on boards
  for insert to authenticated with check (auth.uid() = created_by);

create policy "Individuals can view their own boards."on boards 
  for select to authenticated using (auth.uid() = created_by);

create policy "Individuals can update their own boards" on boards
  for update to authenticated using (auth.uid() = created_by);

create policy "Individuals can remove their own boards" on boards
  for delete to authenticated using (auth.uid() = created_by);
  ```
rls for lists
```
alter table lists enable row level security;

create policy "Individuals can insert a list on their board" on lists
  for insert to authenticated with check (auth.uid() in (
    select created_by from boards where board_id = id
  ));

create policy "Individuals can view a list on their board."on lists 
  for select to authenticated using (auth.uid() in (
    select created_by from boards where board_id = id
  ) 
);

create policy "Individuals can update a list on their board."on lists 
  for update to authenticated using (auth.uid() in (
    select created_by from boards where board_id = id
  ) 
);
```
rls for tasks
```
alter table tasks enable row level security;

create policy "Individuals can insert a task on their board" on tasks
  for insert to authenticated with check (auth.uid() in (
    select created_by from boards where boards.id = (
      select board_id from lists where lists.id = list_id
    )
  ));

create policy "Individuals can view their own task." on tasks 
  for select to authenticated using (auth.uid() = created_by);

create policy "Individuals can update their own task." on tasks 
  for update to authenticated using (auth.uid() = created_by);

create policy "Individuals can remove their own task." on tasks 
  for delete to authenticated using (auth.uid() = created_by);
```

rls for users
```
alter table users enable row level security;

create policy "Individuals can view their own user."on users 
for select to authenticated using (auth.uid() = id);

create policy "Individuals can update their own user" on users
  for update to authenticated using (auth.uid() = id);

create policy "Individuals can remove their own user" on users
  for delete to authenticated using (auth.uid() = id);
```

## Utils

drop tables in public schema
```
do $$ declare
    r record;
begin
    for r in (select tablename from pg_tables where schemaname = 'public') loop
        execute 'drop table if exists ' || quote_ident(r.tablename) || ' cascade';
    end loop;
end $$;
```
